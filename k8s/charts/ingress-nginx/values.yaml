# Ingress NGINX configuration for Kind cluster
ingress-nginx:
  controller:
    # HA: Multiple replicas for high availability
    replicaCount: 2

    # Use hostPort for Kind cluster (ports 80/443 are mapped in kind-config.yaml)
    hostPort:
      enabled: true
      ports:
        http: 80
        https: 443

    # Required for Kind: run on control-plane node with ingress-ready label
    nodeSelector:
      ingress-ready: "true"

    # Tolerate control-plane taint
    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"

    # Use host network for direct access
    hostNetwork: false

    # Service configuration - use ClusterIP since hostPort handles external access
    service:
      type: ClusterIP

    # Resource limits
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # HA: Liveness and readiness probes
    livenessProbe:
      httpGet:
        path: /healthz
        port: 10254
        scheme: HTTP
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 3
      failureThreshold: 3
      successThreshold: 1

    readinessProbe:
      httpGet:
        path: /healthz
        port: 10254
        scheme: HTTP
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 3
      failureThreshold: 3
      successThreshold: 1

    # Enable metrics for Prometheus
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        namespace: monitoring

    # Admission webhooks
    admissionWebhooks:
      enabled: true

    # HA: Update strategy for zero-downtime deployments
    updateStrategy:
      type: RollingUpdate
      rollingUpdate:
        maxUnavailable: 0
        maxSurge: 1

    # HA: Pod anti-affinity to spread across nodes
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: ingress-nginx
                  app.kubernetes.io/component: controller
              topologyKey: kubernetes.io/hostname

    # HA: Autoscaling
    autoscaling:
      enabled: true
      minReplicas: 2
      maxReplicas: 5
      targetCPUUtilizationPercentage: 70
      targetMemoryUtilizationPercentage: 80

    # HA: Pod Disruption Budget
    podDisruptionBudget:
      enabled: true
      minAvailable: 1

    # Network Policy - allow all ingress traffic to controller
    networkPolicy:
      enabled: true

  # Default backend (optional)
  defaultBackend:
    enabled: false
